# 计算机网络  
docsify serve com-net

## 一 基本概念
> 网络由若干**节点**（node）和连接节点的**链路**（link）组成  
> 多个网络通过路由器互连，构成更大的网络，即互联网  
> 因特网：世界上最大的互连网络  
> 因特网服务提供者ISP 
> 因特网很大的特点是**面向公众**  
> 因特网组成
* 边缘部分：主机（用户直接使用），用来通信
* 核心部分：由不部分网络和连接网络的**路由器**组成，维边缘部分提供服务

### 1.1 交换方式
电路交换（步骤：建立连接；通话；释放连接）：使用其传送计算机数据，线路传输效率很低(模拟、数字数据均可)
**分组交换**：常使用**（重要）**
报文交换：不常使用
三种交换方式的比较
![交换方式的比较](概述\交换方式的比较.png "交换方式的比较")



### 1.2 基本概念
> 计算机网络（定义不统一）：较好的定义：计算机网络主要是有一些通用的、可编程的硬件**互连**而成的，这些硬件**并非**专门实现某一特定目的。这些可编程的硬件能够用来传送**多种不同类型**的数据，并能支持广泛的和日常增长的应用。  



> **广域网WAN**  城域网MAN **局域网LAN  个域网PAN**

### 1.3 计算机网络的性能指标
> 比特：数据量的单位，一个比特是二进制数字的一个1或0；  
$$ 8 bit=1 Byte $$; $KB =2^10 B $ $ MB=K KB $ ; $ GB=K MB =10^30 B$ ; $ TB=K GB $  

| 指标 | 定义 | 单位 | 注意 |
| ---- | ---- | ---- | ---- |
| 速率（比特率或数据率） | 连接在计算机网络上的主机在数字信道上传送比特的速率 | bit/s(b/s,bps);kb/s=10^3 b/s(bps)；Mb/s=k*k/s; Gb/s; Tb/s |  |
| 带宽 | (模拟信号)**信号**所包含的各种不同频率成分所占据的**频率范围**（计算机网络）用来表示网络的**通信线路**所能传送数据的能力（“**最高数据率**”） | b/s; kb/s；Mb/s; Gb/s; Tb/s |  |
| 吞吐量 | 在单位事件内某个网络（或信道、接口）的数据量 |      | 吞吐量**受网络的带宽或额定速率的限制** |
|时延||||
|时延带宽积|**传播时延和带宽**的成绩||链路的时延带宽积又称**以比特为单位的链路长度**|
|往返时间|多数，为双向交互|||
|利用率|信道利用率；网络利用率||**并非越高越好**（越高，该信道引起的时延也会迅速增加）；**太低也不好**（通信资源被浪费）|
|丢包率（分组丢失率）|在一定时间内，传输过程中**丢失的分组数量与宗分组数量的比率**|||

> 时延  
> ![时延](概述\时延.png "时延")
>
> 

### 1.4 计算机网络体系结构（重要！）

> 常见的计算机网络体系结构 
>
> OSI 不适合商用；结构部分重复；流程长
>
> ![常见计算机网络体系结构](概述\常见计算机网络体系结构.png "常见计算机网络体系结构")



> 分层的必要性：
>
> ![分层必要性](概述\分层必要性.png "分层必要性")
>
> 数据链路层的服务访问点是帧的“类型”字段
>
> 网络层的服务访问点是IP数据报首部的“协议字段”
>
> 运输层的服务访问点是“端口号”



### 1.5 专用术语（实体、协议、服务）

> **实体**：任何可发送或接收信息的硬件或软件进程
>
> 对等实体：收发双方**相同层次中的实体**
>
> **协议**：控制两方对等实体进行**逻辑通信**的规则的集合
>
> **协议的三要素**：语法、语义、同步
>
> 在协议的控制下，两个对等实体间的逻辑通信使得本层能够想上一层提供服务
>
> 要实现本层协议，还需要使用下面一层所提供的服务
>
> 协议是**水平**的，服务是**垂直**的
>
> 实体看得见相邻下层所提供的服务，但不知道实现该服务的具体协议
>
> **服务访问点**：在同一系统中相**邻两层的实体交换信息的逻辑接口**，用于区分不同的服务类型
>
> 服务原语：上层使用下层所提供的服务必须提供与下层**交换一些命令**，这些命令为服务原语
>
> 协议数据单元PDU ： **对等层次之间传送的数据包**
>
> 服务数据单元SDU : **同一系统内，层与层之间交换的数据包**
>
> 多个SDU可以合并一个PDU；一个SDU可划分为几个PDU

## 二 物理层

> 物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流
>
> 物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不是考虑网络具体的传输媒体是什么



> 物理层协议的重要任务：
>
> * 机械特性：指明接口所用接线器的**形状和尺寸、引脚数目和排列、固定和锁定**装置
> * 电气特性：指明在接口电缆的各条线上出现的**电压范围**
> * 功能特性：指明在条线上出现的某一电平的**电压表示何种意义**
> * 过程特性：指明对于不同功能的各种**可能事件的出现顺序**



>  传输媒体

* 引导型传输媒体（双绞线、同轴电缆、光纤）
* 非引导型传输媒体（微波通信（2-40GHz））



> 传输方式
>
> 串行传输（远距离）和并行传输（效率高，成本高，计算机内部）
>
> 同步传输（双方时钟同步：外同步和内同步）和异步传输
>
> 单向通信（单工）、双向交替通行（半双工）和双向同时通信（全双工）



> 编码与调制
>
>  ![编码与调制](物理层\编码与调制.png "编码与调制")
>
> 码元：在使用时间域的波形表示数字信号时，**代表不同离散数值的基本波形**



> 常见编码
>
> * 不归零编码（存在零编码）：需要额外一根传输线来传输时钟信号，使发送和接受方同步；对于计算机网络，宁愿利用这根传输线传输数据信号，而不是时钟信号
> * 归零编码（自同步，编码效率低）：每个码元传输结束信号要“归零”；“自同步”信号；数据带宽大部分来传输“归零”而浪费了
> * 曼彻斯特编码（传统以太网）：码元中间时刻的跳变既表示时钟，又表示数据
> * 差分曼彻斯特编码（比曼彻斯特编码变化少，更适合较高的传输速率）：跳变仅表示时钟；码元开始处电平是否发生变化数据



> 基本调整方法（一元调制）
>
> ![基本调整方法](物理层\基本调整方法.png "基本调整方法")
>
> 混合调制（多元调制）
>
> 因为频率和相位是相关的，即频率是相位随时间的变化率。所以**一次只能调制频率和相位两个中的一个**
>
> 通常情况下，相位和振幅可以结合起来一起调制，称为**正交振幅调制QAM**



> 信道的极限容量
>
> 奈氏准则：在假定的理想条件下，为了避免码间串扰，码元传输速率是有上限的
>
> ![奈氏](物理层\奈氏.png "奈氏")
>
> 香农公式：带宽受限且有高斯白噪声干扰的信道的极限信息传输速率
>
> ![](物理层\香农.png "香农")
>
> 在信道带宽一定的情况下，根据奈氏准则和香农公式，要想**提高信息的传输速率**就必须采用**多元制**（更好的调制方法）和努力**提高信道的信噪比**。
>
> 自从香农公式发表后，各种新的信号处理和调制方法就不断出现，目的是尽可能接近香农公式给出的传输速率极限。



## 三 数据链路层

###  3.1 数据链路层概念

**链路**：从一个结点到相邻结点的一段物理线路，而中间码元任何其他的交换结点

**数据链路**：把实现通信协议的硬件和软件加到链路上，构成数据链路

数据链路层以**帧**为单位传输和处理数据

透明传输：**数据链路层对上层交付的传输数据没有任何限制**，好像数据链路层不存在（面向字节的物理链路使用字节（字符）填充的方式实现透明传输；面向比特的物理链路使用比特填充）

为了提高帧的传输效率，应当使**帧的数据部分的长度**尽可能大些

考虑到差错控制等因素，每一种数据链路层协议都规定了帧的数据上限，即**最大传送单元MTU**

比特差错：实际的通信链路不是理想的，比特在传输过程可能产生差错：1》0；0》1

**误码率BER**：在一段时间内，传输错误的比特占所传输比特总数的比率

使用**差错检测码**来检测数据在传输过程中是否产生了比特差错



> 数据链路层的三个重要问题：
>
> * **封装成帧**：数据链路层给上层交付的协议数据单元增加帧头和帧尾使之成为帧(帧头帧尾的作用有帧)
>
> * **差错检查**：检错码封装在帧尾
>
> * **可靠传输**：尽管误码是不能完全避免的，但若能实现发送方发送什么，接收方就能收到什么，称为可靠传输



> 使用广播信道的数据链路层
>
> * 共享式以太网的媒体接入控制协议CSMA/CD
> * 802.11局域网的媒体接入控制协议CSMA/CA



> 数据链路层的互连设备



> 差错校验
>
> | 方法                                                | 概念                                                         | 可以检测出误码                                               | 不以检测出误码                                               | 漏检率 |
> | --------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------ |
> | 奇偶校验（一般不采用）                              | 在待发送的数据后面添加1位奇偶校验位，使整个数据（包括所添加的校验位在内）中"1"的个数位奇数或偶数 | 如果有**奇数**个位发生误码，则奇偶性发生变化，**可以**检测出误码 | 如果有偶数个位发生误码，则奇偶性不发生变化，**不可**检测出误码 | 高     |
> | 循环冗余校检CRC(算法要求生成多项式必须包括最低次项) | 1 收发双方约定好一个**生成多项式 G(x)** 2 发送方基于待发送的数据和生成多项式计算出差错检测码（**冗余码**），将其添加到待传输的后面一起传输 3 接收方通过生成多项式来计算收到的数据是否产生了误码 |                                                              |                                                              | 极低   |
>
> **检错码**只能检测出帧在传输过程中出现差错，但不能定位错误，因此**无法纠正错误**
>
> 要想纠正错误，可以使用冗余信息更多的**纠错码**进行**前向纠错**。但纠错码开销比较大，在**计算机网络中较少使用**
>
> **CRC**有较好的检错能力（**漏检率非常低**），虽然计算复杂，但非常**易于用硬件实现**，因此**广泛应用于数据链路层**
>
> 在计算机网络通常采用**检错重传方式来纠正传输中的差错**，或者仅仅**是丢弃检测到差错的帧**，这取决于数据链路层向其上层提供的是可靠传输服务还是不可靠传输服务。
>
> ![CRC](数据链路层\CRC.png "CRC")



### 3.2 可靠传输

> 数据链路层向上提供都五福类型
>
> * **不可靠传输服务**：**仅仅丢弃有误码的帧**，其他不做
> * **可靠传输服务**：想办法实现**发送端发送什么，接收端就收到什么**
>
> 一般情况，**有线链路**的误码率比较低，位减少开销，并**不要求数据链路层向上提供可靠传输服务**，即使出现误码，可靠传输的问题由上层处理
>
> **无线链路**易受干扰，误码率比较高，因此**要求数据链路层**必须向上提供可靠传输服务
>
> 传输差错：**比特差错、分组丢失、分组失序、分组重复**
>
> 比特差错一般出现在数据链路层，分组丢失、分组失序、分组重复一般出现在数据链路层上层
>
> **可靠传输服务并不仅局限于数据链路层**，其他各层均可选择可靠传输
>
> 可靠传输的实现比较复杂，开销比较大，是否使用可靠传输取决于应用需求。



#### 3.2.1 可靠传输的实现机制

可靠传输的实现机制的基本原理可应用到计算机网络体系结构的各层协议。

> 停止-等待协议SW
>
> ![SW](数据链路层\SW.png "SW")
>
> * 接收端检测到数据分组有误码时，将其丢弃并等待发送发的超时重传，但对于误码率较高的点对点链路，为使发送方**尽早重传**，也可给**发送方发送NAK分组**
> * 为了让接收方能够判断所收到的数据分组是否重复，需要给**数据分组编号**，由于停止-等待协议的停等特性，**只需1个比特**：0和1
> * 为了让发送方能够判断是收到的ACK分组是是否重复的，需要**给ACK分组编号**，所用比特数量**与数据分组所用比特数量一样**。数据链路层一般不会出现ACK分组迟到的情况，因此**在数据链路层实现停止-等待协议可以不用给ACK分组编号**
> * 超时计时器设置的**重传时间**应仔细选择，一般可将重传时间选为**略大于"从发送方到接收方的平均往返时间"**
> * * 在数据链路层点对点的往返时间比较缺点，重传时间比较好设定
>   * 在运输层，由于端到端往返时间非常不确定，设置合适的重传时间有时并不容易
>
> ![SW的信道利用率](数据链路层\SW的信道利用率.png "SW的信道利用率")
>
> **当往返时延RTT远大于数据帧发送时延Td时（eg:使用卫星链路），信道利用率非常低**
>
> 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低
>
> 为克服停止-等待协议信道利用率低的缺点，就产生了后退N帧协议GBN和选择重传协议SR



> 后退N帧协议GBN
>
> ![GBN](数据链路层\GBN.png "GBN")
>
> 回退N帧协议的接收窗口尺寸WR只能等于1，因此接收方只能按序接收正确到达的数据分组
>
> 问题：一个数据分组的误码会导致其后续多个数据分组（尽管正确）不能被接收方按序接收而丢弃。这会造成发送方对这些数据分组的超时重传。



> 选择重传协议SR
>
> 定义：接收窗口的尺寸**WR大于1**，以便**接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组**，等到所缺分组收齐后一并送交上层。
>
> **SR**为了使发送方仅重传差错的分组，接收方**不能再采用累计确认**，而需要对每个正确接收到的数据分组进行**逐一确认**。
>
> ![SR](数据链路层\SR.png "SR")



### 3.3 点对点协议PPP

> PPP 协议是目前使用最广泛的点对点数据链路层协议
>
> PPP 协议为点对点链路层传输各种协议数据提供了一个标准方法，主要由三部分构成：
>
> * 对各种协议数据报的封装方法（封装成帧）
> * 链路控制协议LCP（用于建立、配置以及测试数据链路的连接）
> * 一套网络控制协议NCPs （其中的每一个协议支持不同的网络层协议）
>
> ![PPP帧](数据链路层\PPP帧.png "PPP帧")
>
> ![PPP 透明传输](数据链路层\PPP 透明传输.png "PPP 透明传输")
>
> ![PPP 差错检测](数据链路层\PPP 差错检测.png "PPP 差错检测")
>
> 接收方每收到一个PPP帧，就进行CRC检验。若CRC检验正确，就接收；反之丢弃。
>
> 使用PPP的数据链路层**向上不提供可靠传输服务**。
>
> ![PPP 工作状态](数据链路层\PPP 工作状态.png "PPP 工作状态")
>
> 

### 3.4 媒体接入控制MAC

> MAC：共享信道着重考虑一个问题是如何协调多个发送和接收站点对一个共享传输媒体的占用，即MAC
>
> ![MAC](数据链路层\MAC.png "MAC")
>
> 随着技术发展，交换技术的成熟和成本的降低，具有更高性能的使用点对点链路和链路层交换机的交换式局域网在有线领域已完全取代了共享式局域网，但由于无线信道的广播天性，无线局域网仍然使用是共享媒体技术。
>
> > 以太网目前从共享式以太网发展到**交换式以太网**
>
> 
>
> > 网络适配器
> >
> > * 要将计算机连接到以太网，需要使用相应的**网络适配器**（简称“**网卡**”）
> > * 在计算机内部，网卡与CPU之间的通信，一般是通过计算机主板上的I/O总线以并行传输方式进行
> > * **网卡与外部以太网**（局域网）之间的通信，一般是通过传输媒体（同轴电缆、双绞线电缆、光纤）以**串行方式**进行的
> > * 网卡除要**实现物理层和数据链路层功能**，其另外一个重要功能就是要进行**并行传输和串行传输的**转换。由于网络的传输速率和计算机内部总数上的传输速率并不相同，因此在网卡的核心芯片中都会包含用于缓存数据的存储器。
> > * 在确保网卡硬件正确的情况下，为了使网卡正确工作，还必须要在计算机的os中为网卡安装相应的设备驱动程序。**驱动程序**负责驱动网卡发送和接收帧。
>
> 
>



#### 3.4.1 静态划分信道

> 复用：通过一条物理线路同时传输多路用户的信号。
>
> 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量时，可利用复用技术来充分利用传输媒体的带宽
>
> 信道复用：频分复用FDM、时分复用TDM、波分复用WDM、码分复用CDM



> 频分复用FDM的所有用户同时占用不同频带资源并行通信
>
> ![FDM](数据链路层\FDM.png "FDM")



> 时分复用TDM的所有用户在不同时间占用同样的频带宽度
>
> ![TDM](数据链路层\TDM.png "TDM")



> 波分复用WDM
>
> ![WDM](数据链路层\WDM.png "WDM")



> 码分复用CDM是一种共享信道的方法。由于该技术主要用于多址接入，更常用码分多址CDMA
>
> CDM的每一个用户可以**在同样的时间使用同样的频带进行通信**
>
> 由于**各用户使用经过特殊挑选的不同码型**，因此**各用户之间不会造成干扰**
>
> ![CDM](数据链路层\CDM.png "CDM")
>
> 



#### 3.4.2 动态接入控制

> **载波监听多址接入/碰撞检测CSMA/CD（总线局域网使用协议）**
>
> ![CSMA/CD](数据链路层\CSMA_CD.png "CSMA/CD")
>
> 以太网采取一种叫做强化碰撞的措施。当发送帧的站点一旦检测到碰撞，除了立即停止发送帧外，还要再继续发送32bit或48bit的人为干扰信号，以便有足够多的碰撞信号使所有站点都能检测除碰撞。
>
> 争用期（碰撞窗口）
>
> ![争用期](数据链路层\争用期.png "争用期")
>
> 最小帧长
>
> * 以太网规定最小帧长为64字节，即512bit
> * 以太网的最小帧长确保了主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞
> * 凡长度小于64字节的帧都是由于碰撞而异常中止的无效帧
>
> 最大帧长
>
> * 以太网V2的MAC帧：最大长度为1418帧
>
> 截断二进制指数退避算法
>
> ![退避时间](数据链路层\退避时间.png "退避时间")
>
> * 若连续多次发生碰撞，就表明可能有较多的主机参与竞争信道。但使用截断二进制指数退避算法**可使重传需要推迟的平均时间随重传次数而增大（动态退避）**，因而**减少发生碰撞的概率**，有利于整个系统的稳定
> * **当重传达16次仍不能成功时**，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则**丢弃该帧**，并向高层报告。
>
> 信道利用率
>
> ![信道利用率](数据链路层\信道利用率.png "信道利用率")



> **载波监听多址接入/碰撞避免CSMA/CA（无线局域网使用的协议）**
>
> * **在无线局域网中，仍可以使用载波监听多址接入CSMA**
> * **在无线局域网中，不能使用碰撞检测CD**。原因：
> * * 无线信道信号强度动态范围大。**如果要在无线网卡上实现碰撞检测CD，对硬件的要求非常高**
>   * 无线电波传输**存在隐蔽站问题，进行碰撞检测的意义页不大**
> * **802.11无线局域网**使用CSMA/CA协议，在CSMA的基础上增加了**碰撞避免CA功能**，不再实现碰撞检测功能
> * 由于**不可能避免所有碰撞**，且**无线信道误码率较高**，802.11标准使用数**据链路层确认机制（停止-等待协议）**来保证数据被正确接收
> * 802.11的MAC层标准定义了两种不同的媒体接入控制方式：**分布式协调功能DCF**（默认方式）；**点协调功能PCF**（实际较少使用）
> * 802.11标准规定，**所有的站点必须在持续检测到信道空闲一段时间后才能发送帧**，这段时间称为**帧间间隔IFS**
> * IFS的长短取决于该站点要发送的帧的类型：高优先级帧和低优先级帧
> * 常用的两种帧间间隔：**短帧间间隔SIFS**（28us）和**DCF帧间间隔**（128us）
>
> ![CSMA/CA工作原理](数据链路层\CSMA_CA工作原理.png "CSMA/CA工作原理")
>
> * 当站点检测到信道是空闲的，并且所发送的数据帧不是成功发送完上一个帧之后立即连续发送的数据帧，则不需要退避算法
> * 必须使用退避算法：在发送数据帧之前检测到信道处于忙状态时；在每一次重传一个数据帧时；在每一次成功发送后连续发送下一个帧时



### 3.5  MAC地址 IP地址以及ARP协议

> **MAC 地址**
>
> MAC 地址是以太网的MAC子层所使用的地址（数据链路层）
>
> IP地址是TCP/IP体系结构网络层所使用的地址（网际层）
>
> ARP协议属于TCP/IP体系结构的网络层，其作用是已知设备所分配到的IP地址，使用ARP协议可以通过该IP地址获取设备的MAC 地址 （网际层）
>
> MAC地址
>
> **数据链路层必须使用地址来区分各主机**
>
> 当多个主机连接在统一广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个**唯一的标识，**即**一个数据链路层地址**
>
> 在每个主机发送的**帧的首部**中，都**携带**有发送主机（源主机）和接收主机（目的主机）的**数据链路层地址**。由于这类地址用于**媒体接入控制（MAC）**的，因此被称为**MAC地址**
>
> MAC地址一般被固化在网卡的电可擦可编程只读存储器EEPROM中，因此MAC地址也被称为**硬件地址**。
>
> MAC地址有时被称为**物理地址**（物理地址属于数据链路层范畴，不属于物理层）
>
> 一般，普通用户计算机中往往会包含两块网卡
>
> * 一块是用于接入有线局域网的以太网卡
> * 一块是用于接入无线局域网的Wi-Fi网卡
>
> 每块网卡都有一个**全球唯一的MAC地址**
>
> 严格来说，MAC地址是对网络上**各接口**的唯一标识，而不是对网络上各设备的唯一标识
>
> 全球单播MAC地址具有唯一性，往往于用户个人信息绑定在一起。因此，用户应尽量确保自己拥有的全球单播MAC地址不被泄露
>
> 为了避免用户设备连接 wifi 热点时，MAC地址泄露的安全问题，目前大多数移动设备都已经采用随机MAC地址技术
>
> ![MAC](数据链路层\MAC-1.png "MAC-1")



> **IP 地址**
>
> IP地址是因特网上的主机和路由器所使用的地址，用于标识两部分信息：
>
> * 网络编号：标识因特网上数以百万计的网络
> * 主机编号：标识同一网络上不同主机
>
> ![IP地址](数据链路层\IP地址.png)



> 地址解析协议ARP协议
>
> ARP协议只能在一段链路或一个网络上使用，不能跨网络使用
>
> ![总结](数据链路层\IP_MAC_ARP.png)



### 3.6 集线器与交换机的区别

> ![HUB](数据链路层\集线器.png)
>
> 以太网交换机
>
> ![以太网交换机](数据链路层\交换机.png)



> ![对比](数据链路层\对比.png)



### 3.7 以太网

> 以太网交换机自学习和转发帧的流程
>
> * 以太网交换机工作在**数据链路层**（包括物理层）
> * 以太网交换机收到帧后，在帧交换表中查找**帧的目的MAC地址所对应的接口号**，然后通过该接口转发帧
> * 以太网交换机是一种即插即用设备，刚上电启动时其内部帧交换表是空的，随着网络中各主机间的通信，以太网交换机通过**自学习算法**自动逐渐**建立起帧交换表**
> * 帧交换表的每条记录都有自己的**有效时间**，到期自动删除：**MAC地址与交换机接口对应关系不是永久的**



> 以太网交换机的生成树协议STP
>
> * 添加**冗余链路**可以提高以太网的可靠性，但可能会形成**网络环路**
> * 网络环路的问题：
> * * **广播风暴**：大量消耗网络资源，使得网络无法正常转发其他数据帧
>   * **主机收到重复的广播帧**：大量消耗主机资源
>   * 交换机的帧交换表震荡（漂移）
> * **STP可以在增加冗余链路来提高网络可靠性的同时又避免网络环路带来的各种问题**
> * * 交换机都能够自动计算并构建一个逻辑上没有环路的网络，其逻辑拓扑结构必须是树型的
>   * 最终生成的树型逻辑拓扑要确保连通整个网络
>   * 当首次连接交换机或网络**物理拓扑发生变化**时（可能是人为改变或故障），交换机都将进行**生成树的重新计算**



### 3.8 虚拟局域网VLAN

> 以太网交换机工作在**数据链路层**（包括物理层）
>
> 使用一个或多个以太网交换机互连起来的交换式以太网，其所有站点属于**同一个广播域**
>
> 广播域带来的**弊端**：
>
> * 广播风暴：**会浪费网络资源和各主机的CPU资源**
> * 难以管理和维护
> * 潜在的安全问题
>
> 网络中会频繁出现广播消息
>
> 分割广播域的方法
>
> * 使用路由器可以隔离广播域（路由器成本高）
> * 虚拟局域网VLAN
>
> 虚拟局域网VLAN是一种将局域网内的设备划分与物理位置无关的逻辑的技术，这些逻辑组具有，某些共同的需求



> **虚拟局域网VLAN的实现机制**
>
> 在交换机上实现
>
> ![IEEE 802.1Q帧](数据链路层\IEEE.png)
>
> 交换机各端口的缺省VLAN ID （华为称为Port VLAN ID 简称PVID）
>
> | 交换机的端口类型 | 注意                                                         | 接收处理方法                                                 | 发送处理方法                                                 |
> | ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
> | Access           | 一般用于连接用户计算机；只能属于一个VLAN；PVID值与端口所属VLAN的ID相同（默认为1） | 一般指接收“未打标签”的普通MAC帧。根据接收帧的端口的PVID给帧“**打标签**”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等 | 若帧中的VID与端口的PVID相等，则“**去标签**”并**转发**该帧；否则不转发 |
> | Trunk            | 一般用于交换机之间或交换机与路由器之间的互连；可以属于多个VLAN；用户可以设置Trunk端口的PVID值。默认情况，PVID为1 | 对VID等于PVID的帧，**“去标签”再转发**；                      | 接收“未打标签”的帧。根据接收帧的端口的PVID给帧“**打标签**”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等 |
> | Hybrid           | 既可用于交换机之间或交换机与路由器之间的互连（Trunk），也可用于交换机与用户计算机之间的互连（Access）；属于多个VLAN；用户可以设置Hybrid端口的PVID值。默认情况，PVID为1 | 查看帧的VID是否在端口的“去标签”列表中：存在，则“去标签”再转发；不存在，则直接转发 | 接收“未打标签”的帧。根据接收帧的端口的PVID给帧“**打标签**”，即插入4字节VLAN标记字段，字段中的VID取值与端口的PVID取值相等；接收“已打标签的帧” |



## 四 网络层（学习是基于TCP/IP协议栈的网际层）

> 网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**
>
> 要实现网络层任务，需要解决的主要问题
>
> * 网络层向运输层提供怎样的服务：可靠传输or不可靠传输
> * 网络层寻址问题
> * 路由选择问题
>
> **因特网**使用**TCP/IP协议栈**，TCP/IP协议栈的网络层使用**网际协议IP**，它是真个协议栈的核心协议，因此在TCP/IP协议栈的网络层常称为**网际层**。



> 网络层提供的两种服务
>
> * 面向连接的虚电路服务
> * 无连接的数据报服务（因特网）
>
> 面向连接的虚电路服务
>
> * 可靠通信由网络来保证
> * 必须建立网络层的连接：虚电路VC
> * 通信双方沿着已建立的虚电路发送分组
> * 目的主机的地址仅在连接建立阶段使用，之后每个**分组的首部只需要携带一条虚电路的编号**
> * 如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方
> * **通信结束后，需要释放之前所建立的虚电路**
>
> 无连接的数据报服务
>
> * **可靠通信由用户主机来保证**
> * **不需要建立网络层的连接**
> * **每个分组可走不同的路径**
> * 每个分组的**首部必须携带目的主机的完整地址**
> * 这种通信方式所传送的分组可能**误码、丢失、重复和失序**
> * 由于**网络本身不提供端到端的可靠传输服务**，使得网络中的路由器可以做得比较简单，价格低
> * 因特网采用这种设计思想，**将复杂的网络处理功能置于因特网的边缘（用户主机和其内部的运输层）**，而将相对简单的尽最大努力的分组交付功能置于因特网核心
>
> ![网络层服务](网络层\网络层.png)



### 4.1 IPv4

> **IPv4 地址**是给因特网上的**每一台主机（或路由器）**的每一个接口分配一个在全世界范围内**唯一的32比特的标识符**
>
> IPv4 地址的编制方法经历了三个历史阶段：分类编址；划分子网；无分类编址
>
> 32比特的IPv4地址不方便阅读、记录以及输入等，因此IPv4地址采用**点分十进制表示方法**以方便用户使用。



> 分类编址的IPv4地址
>
> ![分类编址](C:\ubuntu\net_file\com-net\网络层\分类编址.png)



> 划分子网的IPv4地址
>
> 为新增网络申请的网络号会带来弊端：
>
> * 需要等待时间和花费更多的费用
> * 会增加其他路由器中路由表记录的数量
> * 浪费原有网络中剩余的大量IP地址
>
> ![32比特的子网掩码](网络层\32比特.png)
>
> ![默认子网掩码](网络层\默认子网.png)



> 无分类编址的IPv4 地址
>
> * 划分子网一定程度上缓解了因特网在发展中遇到的困难，但**数量巨大的C类网因为其地址空间太小并没有得到充分使用**，而因特网的IP地址仍在加速消耗，整个**IPv4 地址空间面临全部耗尽的威胁，故提出无分类编址的IPv4 地址**
> * **无分类域间路由选择CIDR**
> * * **CIDR 消除了传统的A类、B类和C类地址，以及划分子网的概念**
>   * **CIDR 可以更加有效分配IPv4 地址空间**，在IPv6使用前允许因特网持续增长。
> * CIDR使用**“斜线记法**”或称CIDR记法。即在IPv4地址后加斜线“/”，在**斜线后面写上网络前缀所占比特数量**
> * CIDR是将网络前缀都相同的连续IP地址组成一个“CIDR地址块”
> * **路由聚合**（构造超网）
> * * 网络前缀越长，地址块越小，路由月具体
>   * 若路由器查表分组时发现有多条路由可选，则选择网络前缀最长的那条，称为**最长前缀匹配**，因为路由更具体



> IPv4地址的应用规划
>
> ![IPv4地址应用规划](网络层\IPv4地址应用规划.png "IPv4地址应用规划")

### 4.2 IP数据报的发送和转发过程

> IP数据报的发送和转发过程
>
> * 主机发送IP数据报
> * * 判断目的主机是否与自己在同一个网络
>   * 若在同一个网络，则属于直接交付
>   * 若不在同一个网络，则属于间接交付，传输给主机所在网络的默认网关（路由器），由默认网关帮忙转发
> * 路由器转发IP数据报
> * * 检测IP数据报首部是否出错：出错，直接丢弃并通告源主机；没出错，则进行转发
>   * 根据IP数据报的目的地址在路由表中查找匹配的条目：若找到，则转发条目中指示的下一条；若没有找到，直接丢弃并通告源主机



### 4.3 静态路由配置

> 静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器**人工配置路由表**
>
> * 人工配置方式简单，开销小。但**不能及时适应网络状态（流量，拓扑等）的变化**
> * 一般在小规模网络采用
>
> 使用静态路由配置可能出现**导致路由环路**的错误
>
> * 配置错误
> * 聚合了不存在的网络
> * 网络故障
>
> 路由条目的类型：直连网络；静态路由（人工配置）；动态路由（路由选择协议）
>
> 特殊的静态路由条目
>
> * 默认路由（目的网络为0.0.0.0，地址掩码为0.0.0.0）
> * 特征主机路由（目的网络为特征主机路由IP地址，地址掩码为255.255.255.255）
> * 黑洞路由（下一条为null0）



### 4.4 路由选择协议

> ![路由选择协议](网络层\路由选择协议.png)
>
> 因特网所采用的路由限制协议的主要特点
>
> * 自适应：动态路由选择
> * 分布式：路由器之间交换路由信息
> * 分层次：将整个因特网划分为许多较小的自治系统AS



> 路由信息协议RIP
>
> * 路由信息协议RIP是内部网关协议IGP中最先得到广泛使用的协议之一，其标准文档RFV 1058
> * RIP要求自治系统AS内的每个路由器都要维护从它自己到AS内其他每一个网络的距离记录。这是一组距离，称为“距离向量”
> * RIP使用跳数作为度量来衡量到达目的网络的距离
> * * 路由器到直连网络的距离定义为1
>   * 路由器到非直连网络的距离定义为所经过的路由器数加1
>   * 也许一条路径最多包含15个路由器。距离等于16时相当于不可达。因此，RIP只适用于小型hlianw
> * RIP认为好的路由就是“距离短”的路由，也就是所通过路由器数量最少的路由
> * 当到达同一目的网络有多条“距离相等”的路由时，可进行等价负载均衡
> * RIP包含3个要点
> * * 和谁交换信息   仅和相邻路由器交换信息
>   * 交换什么信息   自己的路由表
>   * 何时交换信息   周期性交换
> * RIP的基本工作过程
> * 1. 路由器刚开始工作时，只知道自己到直连网络的距离为1
>   2. 每个路由器仅和相邻路由器周期性地交换并更新路由信息
>   3. 若干次交换和更新后，每个路由器都知道到达本AS内各网络的最短距离和i西安一个地址，称为收敛
> * RIP路由条目的更新规则
> * * 发现了新的网络，添加
>   * 到达目的网络，相同下一跳，最新消息，更新
>   * 到达目的网络，不同下一跳，新路由优势，更新
>   * 到达目的网络，不同下一跳，新路由劣势，不更新
>   * 到达目的网络，不同下一跳，等价负载均衡
> * RIP存在“坏消息传播慢”的问题
> * “坏消息传播慢”又称为路由环路或距离无穷计数问题，这是距离向量算法的一个固有问题
> * * 限制最大路径距离为15
>   * 当路由表发生变化时就立即发送更新报文（触发更新），而不仅是周期性发送
>   * 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口相反方向传送（“水平分割”）



> 开放最短路径优先OSPF
>
> 开放最短路径优先OSPF是为了克服RIP开发出来的
>
> * OSPF协议是**公开发表**的
> * 开放最短路径优先使用Dijkstra提出的最短路径算法SPF
>
> OSPF是基于**链路状态**的，采用SPF算法计算路由，从算法上保证了**不会产生路由环路**
>
> OSPF**不限制网络规模**，更新效率高，**收敛速度块快**
>
> 链路状态是指本路由器都**和哪些路由器相邻**，以及相应**链路的“代价”**（距离，带宽，费用等，代价由网络管理人员决定）
>
> 使用OSPF的每个路由器都会产生**链路状态通告LSA**。LSA包括直连网络的链路状态信息和邻居路由器的链路状态信息
>
> LSA被封装在**链路状态更新分组LSU**中，采用**洪泛**法发送
>
> 使用OSPF的每个路由器都有一个**链路状态数据库LSDB**，用于存储LSA
>
> 通过各路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终将达到一致
>
> 使用OSPF的各路由器**基于LSDB进行最短路径优先SPF计算**，构建出各自到达其他路由器的最短路径，即构建各自的路由表
>
> OSPF有五种分组类型：**问候**分组；**数据库**分组；**链路状态请求**分组；**链路状态更新**分组
>
> OSPF在多点接入网络中路由器邻居关系的建立
>
> * 选举**指定路由器DR**和**备用的指定路由器BDR**
> * **所有的非DR/BDR只与DR/BDR建立邻居关系**
> * 非DR/BDR之间通过DR/BDR交换信息
>
> 为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做**区域**
>
> * 区域划分优点：**把利用洪泛法交换链路状体信息的范围局限于每一个区域而不是整个自治系统**



> 边界网关协议BGP
>
> 外部网关协议EGP（eg: 边界网关协议BGP ）
>
> * 在不同自治系统内，度量路由的“代价”（距离，带宽，费用等）可能不同。因此，对于自治系统之间的路由选择，使用“代价”作为度量来寻找最佳路由是不行的
> * 自治系统之间的路由选择必须考虑相关政策（政治，经济，安全等）
> * BGP只能是力求寻找一条能够到达目的网络且比较好的路由，而非寻找一条最佳路由
>
> 在配置BGP时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的**“BGP发言人”**
>
> 不同自治系统的BGP发言人要交换路由信息，首先必须建立**TCP连接**，端口号为179
>
> * 在此TCP连接上交换BGP报文以建立**BGP会话**
> * 利用BGP会话**交换路由信息**
> * 使用TCP连接交换路由信息的两个BGP发言人，彼此称为对方的**邻站或对等站**
>
> BGP发言人除了运行BGP外，还必须运行自己所在自治区系统所使用的内部网关协议IGP，例如OSP或RIP
>
> BGP发言人**交换网络可达性的信息**
>
> 当BGP发言人互相交换了网络可达性信息后，各BGP发言人就根据所采用的策略从收到的路由信息中找到到达**各自治系统的较好的路由**。也就是构造出树型结构，**不存在回路的自治系统连通图**
>
> BGP适用于多级结构的因特网
>
> BGP-4有四种报文：
>
> * **OPEN(打开)报文**：用来与相邻的另一个BGP发言人建立关系
> * **UPDATE（更新）报文**：用来通告某一路由的信息，以及列出要撤销的多条路由
> * **KEEPALIVE（保活）报文**：用来周期性地证实邻站的连通性
> * **NOTIFICATION（通知）报文**：用来发送检测到的差错



### 4.5 IPv4数据报的首部格式

![](网络层\IPv4数据报.png)



### 4.6 网际控制报文协议ICMP

> 为了更加有效地转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP
>
> 主机或路由器使用ICMP来发送**差错报告报文**和**询问报文**
>
> **ICMP报文被封装在IP数据报**中发送
>
> ICMP差错报告报文共有5种：终点不可达；源点抑制；时间超过；参数问题；改变路由（重定向）
>
> **不应发送ICMP差错报告报文**的情况：
>
> * 对ICMP差错报告报文不再发送ICMP差错报告报文
> * 对第一份片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
> * 对具有多播地址的数据报都不发送ICMP差错报告报文
> * 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送ICMP差错报告报文
>
> 常用的**ICMP询问报文****有：回送请求和回答；时间戳请求和回答
>
> ICMP应用：分组网间探测PING；跟踪路由traceroute



### 4.7 虚拟专用网VPN与网络地址转换NAT

![](网络层\VPNandNAT.png)



## 五 运输层

> 运行在计算机上的进程使用**进程标识符PID**来标志
>
> 不同的os,**使用不同格式的进程标识符**
>
> 为了使运行不同os的计算机的应用进程之间能够网络通信，就必须**使用统一的方法对TCP/IP体系的应用进程进行标识**
>
> TCP/IP体系的运输层使用端口号来区分不同的应用进程
>
> * 熟知端口号：0~1023 HTTP：80；DNS：53
> * 登记端口号：1024~49151
> * 短暂端口号：49152~65535，留给客户进程选择暂时使用
>
> **端口号只具有本地意义**，即端口号只是为了**标识本计算机应用层中的各进程**，在因特网中，**不同计算机中的相同端口号是没有联系的**
>
> 发送方的复用和接收方的分用
>
> ![发送方的复用和接收方的分用](运输层\发送方的复用和接收方的分用.png)



> 计算机网络结构中的物理层、数据链路层和网络层共同解决了将主机提高异构网络互连起来的问题，**实现了主机到主机的通信**
>
> 在计算机网络中进行**通信的真正实体是位于通信两端主机中的进程**
>
> **如何为运行在不同主机上的应用进程提供直接的通信服务是运输层的任务**，运输层协议又称为端到端协议
>
> 运输层想高层用户屏蔽了下面网络核心细节（网络拓扑、路由选择协议等等），它使应用进程看见的就好像**是在两个运输层实体之间有一条端到端的逻辑通信信道**
>
> 根据应用需求的不同，因特网的运输层为应用层提供了两种不同的运输协议，**面向连接的TCP和无连接的UDP**



> | 用户数据报协议UDP                                      | 传输控制协议TCP                               |
> | ------------------------------------------------------ | --------------------------------------------- |
> | 无连接                                                 | 面对连接                                      |
> | 支持一对一，一对多，多对一和多对多交互通信             | 每一条TCP连接只能由两个端点EP，只能一对一通信 |
> | 对应用层交付的报文直接打包                             | 面向字节流                                    |
> | 仅最大努力交付，也就是不可靠；不使用流量控制和拥塞控制 | 可靠传输，使用流量控制和拥塞控制              |
> | 首部开销小，8 bit                                      | 首部最小20字节，最大60字节                    |

### 5.1 TCP 

> TCP的流量控制
>
> 流量控制：**让发送方的发送速率不要太快，要让接收方来得及接收**
>
> 利用滑动窗口机制可以在TCP连接上实现对发送方的流量控制
>
> * TCP接收方利用自己的**接收窗口**的大小来限制**发送窗口**的大小
> * TCP发送方收到接收方的**零窗口通知**后，应启动**持续计时器**，持续计时器超时后，向接收方发送**零窗口探测报文**



![](C:\ubuntu\net_file\com-net\运输层\TCP阻塞.png)



![](C:\ubuntu\net_file\com-net\运输层\TCP超时重传时间的选择.png)

> TCP 可靠传输的实现
>
> TCP 基于字节为单位的滑动窗口来实现可靠传输
>
> * 发送方在未收到接收方的确认时，可将发送窗口内还未发送的数据全部发送出去
> * 接收方只接受序号落入发送窗口内的数据
>
> 虽然发送方的发送窗口是根据接收窗口设置的，但在同一时刻，**发送方的发送窗口并不总和接收窗口**一样大
>
> 对于不按序到达的数据应该如何处理，TCP 并无明确规定
>
> * 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样做对网络资源的利用不利，因为放松法回重复传送较多的数据
> * TCP 通常对不按序到达的数据是先临时保存在接收窗口中，等待字节流中所缺少的字节收到后，在**按序交付上层的应用进程**
>
> TCP 要求接收方必须由累计确认和捎带确认机制，课减少传输开销。接收方可再合适的时候发送确认，也可在自己有数据要发送时把确认信息捎带上
>
> * **接收方不应过分推迟发送确认**，否则会导致发送方不惜要的超时重传，反而浪费网络资源
> * 稍等确认实际不常发生，因为大多数应用程序很少同时在两个方向上发送数据
>
> **TCP 的通信是全双工通信**



![](C:\ubuntu\net_file\com-net\运输层\TCP连接建立.png)



![](C:\ubuntu\net_file\com-net\运输层\TCP运输连接管理.png)



![](C:\ubuntu\net_file\com-net\运输层\TCP报文段的首部格式.png)

## 六 应用层

> 应用层是计算机网络体系结构的**最顶层**，是**设计和建立计算机网络的最终目的**



![](C:\ubuntu\net_file\com-net\应用层\C_S.png)



![](C:\ubuntu\net_file\com-net\应用层\DHCP.png)



![](C:\ubuntu\net_file\com-net\应用层\DNS.png)



![](C:\ubuntu\net_file\com-net\应用层\FTP.png)



> 电子邮件系统
>
> 电子邮件系统采用**客户/服务器方式**，三个主要组成构件：**用户代理**、**邮件服务器**、电子邮件所需的**协议**
>
> * 用户代理是用户与电子邮件相同的接口，又称为电子邮件客户端软件
> * 邮件服务器是电子邮件系统的基础设置，因特网上所有的ISP都有邮件服务器，其功能是发送和接受邮件，同时负责维护用户的邮箱
> * 协议包括邮件发送协议和邮件读取协议
>
> 常用的邮件发送协议是**简单邮件传送协议SMTP**
>
> * 基于TCP连接，端口号25
> * 只能传送ASCII码版本
> * 用于用户代理向邮件服务器发送邮件以及邮件服务器之间的邮件发送
>
> 为解决SMTP传送非ASCII码文本的问题，提出了多用途因特网邮件扩展MIME
>
> 常用的邮件读取协议有两个：
>
> * **邮局协议POP3：不允许用户在邮件服务器上管理自己的邮件**
> * **因特网邮件访问协议IMAP：用户在自己计算机上就可以操控邮件服务器中的邮件**，IMAP是联机协议
>
> 基于万维网的电子邮件
>
> * 通过**浏览器**登陆，邮件服务万维网网站可以攥写、收发、阅读和管理电子邮件
> * 这种工作模式在**用户浏览器与邮件服务器网站之间使用HTTP协议，而邮件服务器之间使用SMTP协议**



![](C:\ubuntu\net_file\com-net\应用层\WWW.png)



